## Mikä? Kotitehtävä palvelinten hallinta -kurssille.

Virtuaalikoneen ajo Oracle VM Virtualboxissa Lenovo IdeaPad 1 14" R5-7520U:lla läppärillä.

### Kotitehtävä 1: Viisikko

**x) Lue ja tiivistä.**

### Two Machine Virtual Network With Debian 11 Bullseye and Vagrant.

Vagrantilla voi automaattisesti asentaa Virtualboxiin virtuaalikoneita, joissa on automaattinen Secure Shell kirjautuminen, eikä tarvetta käyttäjän graafiselle käyttöliittymälle ole.

Asennus tapahtuu seuraavasti: 

`sudo apt-get update`
`sudo apt-get install vagrant virtualbox`

Vagrant tiedoston tekeminen: 

Uusi hakemisto projektille ja sinne tiedosto nimeltä Vagrantfile, tiedostoon Teron teksti. 

`mkdir twohost/; cd twohost/`
`nano Vagrantfile`

Kirjautuminen ja uloskirjautuminen:

`vagrant ssh t001`
`exit`

Hajottaminen:

`vagrant destroy`

Uudet koneet samoilla säännöillä: 

`vagrant up`

(Karvinen. 2021)


### Salt Quickstart – Salt Stack Master and Slave on Ubuntu Linux

Ladataan sekä konfiguroidaan master ja minion.

Masterin lataus

- `sudo apt-get -y install salt-master`
- IP-osoitteen selvitys: `hostname -i`

Minionin lataus

- `sudo apt-get update`
- `sudo apt-get -y install salt-minion`

Minionin pitää tietää missä master on ja jokaisella slavella tulee olla uniikki ID.

- `sudoedit /etc/saltminion`
- master: IP-osoite
- id: valitsemasi id

Minion tulee uudelleenkäynnistää, jotta muutokset tulevat voimaan.

- `sudo systemctl restart salt-minion.service`

Ennenkuin master voi kontrolloida minionia, sen tulee hyväksen tunnisteavain.

- `sudo salt-key -A`

Minionin hallinta

- Yhteyden tarkistus: `sudo salt '*' cmd.run whoami`
- Minionin IP-osoitteet: `master$ sudo salt '*' cmd.run 'hostname -I`

(Karvinen. 2018.)

### Hello Salt Infra-as-Code

Salt:n ja micro editorin lataus:

`sudo apt-get update`
`sudo apt-get -y install salt-minion micro`
`export EDITOR=micro`

Hakemisto hello moduulille:

`sudo mkdir -p /srv/salt/hello`
`cd /srv/salt/hello`

Kirjoitetaan infraa koodina:

`sudoedit init.sls`

`tmp/hellotero:
  file.managed`

Ajetaan infraa koodina:

`sudo salt-call --local state.apply hello`

Tarkistetaan:

`ls /tmp/hellotero`
/tmp/hellotero, jos toimii

(Karvinen. 2014)

### Salt Vagrant - automatically provision one master and two slaves

Infra as Code - Your wishes as a text file

Haluttu koodi kansioon /srv/salt/kansio:

`sudo mkdir -p /srv/salt/hello`

Kansioon tiedosto init.sls:

`sudoedit /srv/salt/hello/init.sls`

Tiedostoon YAML syntaxilla, sisännys kahdella välilyönnillä:

`/tmp/infra-as-code:
  file.managed`

Ajaminen:

`sudo salt '*' state.apply hello`

top.sls - What Slave Runs What States

top.sls tiedosto määrittää mitkä minionit ajavat mitkäkin tilat.:

`sudo salt '*' state.apply hello`

`sudoedit /srv/salt/top.sls`

Teksti sinne:

`/srv/salt/top.sls
base:
  '*':
    - hello`

(Karvinen. 2023)

### Salt contributor: Salt overview

YAML:n säännöt

YAML on merkintäkieli.
* Data kirjoitetaan avain: arvo -pareissa.
* Avainten arvo voi olla monissa eri rakenteissa. 
* Kaikki on kirjainlyöntikohtaisista. 
* Kommentit alkavat hashilla #.

YAML yksinkertaiset rakenteet

1. Skalaarit:

avain:arvo -kartoitukset missä arvo voi olla numero, merkkijono tai totuusarvomuuttuja.

#avain: arvo
````
vihannekset: herneet

hedelmä: omenat

jyvät: leipä
````

2. Listat

avain: seurattuna lista arvoista, missä jokainen arvo on erillisellä rivillä ja seuraa kaksi välilyöntiä ja kaksoispiste.

#järjestysavain: 
  - arvo1
  - arvo2

```
vihannekset:
  - herneet
  - porkkanat
hedelmät:
  - omenat
  - appelsiinit
````

3. Hakemisto

Kokoelma avain:arvo kartoituksia ja listoja.

```
lounas:

  alkupala: katkarapu cocktail
  juoma: kupliva vesi
  pääruoka:
    - pihvi
    - perunamuussi
    - päivällisrulla
  jälkiruoka:
    - suklaakakku
```

Listat ja hakemistot - YAML:n lohkorakenne

* YAML on organisoitu lohkorakenteisiin.
* Sisennys asettaa kontekstin. Sinun täytyy sisentää omaisuudet yhdellä tai useammalla väliyönnillä, mutta kaksi välilyöntiä on standardi.
* Kokoelma, mikä on lista tai hakemiston lohkorakenne, ilmaisee jokaisen rivin väliviivalla ja välilyönnillä ("- "). 

(Salt overview. 2021-2024.)


### a) Hello Vagrant! Osoita jollain komennolla, että Vagrant on asennettu. 

![image](https://github.com/user-attachments/assets/5a2e75cc-4f23-4d4a-b8b6-8eed0ca8bd5a)

Kuva 1. Vagrant ladattu

### b) Linux Vagrant. Tee Vagrantilla uusi Linux-virtuaalikone.

Päätin tehdä Windowsilla tämän. Latasin Vagrantin nettisivuilta ohjelmiston, jonka jälkeen tein PowerShellillä kansion twohost ja siirryin sinne.

`mkdir twohost; cd twohost`

Tein sinne tiedoston Vagrantfile ja laitoin sinne Teron koodin, joka tekee kaksi virtuaalikonetta "t001" ja "t002". 

```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :
# Copyright 2019-2021 Tero Karvinen http://TeroKarvinen.com

$tscript = <<TSCRIPT
set -o verbose
apt-get update
apt-get -y install tree
echo "Done - set up test environment - https://terokarvinen.com/search/?q=vagrant"
TSCRIPT

Vagrant.configure("2") do |config|
	config.vm.synced_folder ".", "/vagrant", disabled: true
	config.vm.synced_folder "shared/", "/home/vagrant/shared", create: true
	config.vm.provision "shell", inline: $tscript
	config.vm.box = "debian/bullseye64"

	config.vm.define "t001" do |t001|
		t001.vm.hostname = "t001"
		t001.vm.network "private_network", ip: "192.168.88.101"
	end

	config.vm.define "t002", primary: true do |t002|
		t002.vm.hostname = "t002"
		t002.vm.network "private_network", ip: "192.168.88.102"
	end
	
end
```


### c) Kaksin kaunihimpi. Tee kahden Linux-tietokoneen verkko Vagrantilla. Osoita, että koneet voivat pingata toisiaan.

Käytin b) -kohdassa tehtyjä koneita.

Kirjauduin ensiksi koneeseen t001 ja pingasin konetta t002 ip-osoitteen perusteella.

```
vagrant ssh t001``
ping -c 1 192.168.88.102
``` 

Sain vastauksen:

![image](https://github.com/user-attachments/assets/b32e39b3-8386-433e-beac-142e4fddd88d)

Kuva 2. Pingaus

Kirjauduin ulos t001 koneesta, kirjauduin t002 koneeseen ja pingasin t001 konetta.

![image](https://github.com/user-attachments/assets/473da7fd-09c8-4cfc-87dc-3c8324c921c0)

Kuva 3. Koneet yhteydessä toisiinsa

Koneet yhteydessä toisiinsa!

(Karvinen 2021) 



### d) Herra-orja verkossa. Demonstroi Salt herra-orja arkkitehtuurin toimintaa kahden Linux-koneen verkossa, jonka teit Vagrantilla. Asenna toiselle koneelle salt-master, toiselle salt-minion. Laita orjan /etc/salt/minion -tiedostoon masterin osoite. Hyväksy avain ja osoita, että herra voi komentaa orjakonetta.

Latasin ensimmäisenä masterin t001 koneelle, eli kirjauduin sinne.

``vagrant ssh001`

Aloitin lataamalla curl -ohjelman ja tekemällä hakemiston avaimille.

![image](https://github.com/user-attachments/assets/d453cc6d-0bf5-4f08-a3f1-f6a8b18c8e03)

Kuva 4. Curl asennettu ja hakemisto tehty.

Latasin Saltin avaimen, tallensin sen äsken tekemääni hakemistoon ja latasin Saltin Githubista.

![image](https://github.com/user-attachments/assets/0ca89ff5-60b0-46e5-944b-79cb7b7c5576)

Kuva 5. Latauksia

Sitten tarkistin päivitykset, asensin salt-masterin, sekä potkaisin sen päälle ja tarkistin, että on toiminnassa: 

```
sudo mkdir -p /etc/apt/keyrings
sudo apt-get install curl
curl -fsSL https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public | sudo tee /etc/apt/keyrings/salt-archive-keyring.pgp
curl -fsSL https://github.com/saltstack/salt-install-guide/releases/latest/download/salt.sources | sudo tee /etc/apt/sources.list.d/salt.sources
sudo apt-get update
sudo apt-get install salt-master
sudo systemctl enable salt-master
sudo systemctl start salt-master
sudo salt-call --version
```

![image](https://github.com/user-attachments/assets/0c64d1c3-f285-4af4-aa80-6601bcf7a5fb)

Kuva 6. Salt-master ladattu

Otin kanssa ylös masterin ip-osoitteen, jonka laitan minionin /etc/salt/minion kansioon.

![image](https://github.com/user-attachments/assets/6d5e5e32-a889-4d26-b73f-2efaaa1a7573)

Kuva 7. Masterin ip-osoite

Kirjauduin ulos masterista ja sisään t002 ja sinne samat kuin masteriin, mutta salt-minionin lataus. 

```
sudo mkdir -p /etc/apt/keyrings
sudo apt-get install curl
curl -fsSL https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public | sudo tee /etc/apt/keyrings/salt-archive-keyring.pgp
curl -fsSL https://github.com/saltstack/salt-install-guide/releases/latest/download/salt.sources | sudo tee /etc/apt/sources.list.d/salt.sources
sudo apt-get update
sudo apt-get install salt-minion
sudo systemctl enable salt-minion
sudo systemctl start salt-minion
sudo salt-call --version
```

![image](https://github.com/user-attachments/assets/098b14d6-00ea-4cdf-92f5-44bbe7300180)

Kuva 8. Minion ladattu

Muokkasin /etc/salt/minion tiedostoon masterin ip-osoitteen ja laitoin minionille id:n minion sekä uudelleenkäynnistin minionin.

![image](https://github.com/user-attachments/assets/d7427ee9-eada-47e5-bbc9-ad60b393945b)

Kuva 9. Minion konfiguroitu

Kirjauduin ulos minionista sekä sisään masterin sekä hyväksyin minionin avaimet.

```
exit
vagrant ssh t001
sudo salt-key -A
```

![image](https://github.com/user-attachments/assets/e4cc5dfc-9612-443d-9e5d-b121e6291399)

Kuva 10. Avaimet hyväksytty

Sitten osoitin, että master voi komentaa minionia:

```
sudo salt '*' cmd.run 'whoami'
```

![image](https://github.com/user-attachments/assets/522ddd8e-1e6f-4492-92e1-314aaa2f0504)


Kuva 11. Master ja minion yhteydessä.

(Karvinen 2021)




### e) Hei infrakoodi! Kokeile paikallisesti (esim 'sudo salt-call --local') infraa koodina. Kirjota sls-tiedosto, joka tekee esimerkkitiedoston /tmp/ -kansioon.

![image](https://github.com/user-attachments/assets/be6e3ffe-8e40-4660-be82-7278c175507b)

![image](https://github.com/user-attachments/assets/f44fee51-075b-4f0b-8116-71e0da615a9b)



f) Aja esimerkki sls-tiedostosi verkon yli orjalla.
g) Tee sls-tiedosto, joka käyttää vähintään kahta eri tilafunktiota näistä: package, file, service, user. Tarkista eri ohjelmalla, että lopputulos on oikea. Osoita useammalla ajolla, että sls-tiedostosi on idempotentti.
h) Top file. Automatisoi vähintään kahden tilan / modulin ajaminen. Esim. komento 'sudo salt "*" state.apply' tai 'sudo salt-call --local state.apply' ajaa modulit "hello" ja "apache".



### Lähteet

Karvinen 2021: Two Machine Virtual Network With Debian 11 Bullseye and Vagrant. https://terokarvinen.com/2021/two-machine-virtual-network-with-debian-11-bullseye-and-vagrant/. 


Karvinen 2018: Salt Quickstart – Salt Stack Master and Slave on Ubuntu Linux. https://terokarvinen.com/2018/salt-quickstart-salt-stack-master-and-slave-on-ubuntu-linux/.


Karvinen 2014: Hello Salt Infra-as-Code. https://terokarvinen.com/2024/hello-salt-infra-as-code/


Karvinen 2023: Salt overview. Infra as Code - Your wishes as a text file. top.sls - What Slave Runs What States. https://terokarvinen.com/2023/salt-vagrant/#infra-as-code---your-wishes-as-a-text-file. 


Salt contributors 2021-2024: Salt overview. Rules of YAML. YAML simple structure. Lists and dictionaries - YAML block structures. https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#rules-of-yaml.

Bhi083 2024. H2.md https://github.com/bhi083/Palvelinten_hallinta/blob/main/h2.md
