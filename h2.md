## Mikä? Kotitehtävä palvelinten hallinta -kurssille.

Virtuaalikoneen ajo Oracle VM Virtualboxissa Lenovo IdeaPad 1 14" R5-7520U:lla läppärillä.

### Kotitehtävä 1: Viisikko

**x) Lue ja tiivistä.**

### Two Machine Virtual Network With Debian 11 Bullseye and Vagrant.

Vagrantilla voi automaattisesti asentaa Virtualboxiin virtuaalikoneita, joissa on automaattinen Secure Shell kirjautuminen, eikä tarvetta käyttäjän graafiselle käyttöliittymälle ole.

Asennus tapahtuu seuraavasti: 

`sudo apt-get update`
`sudo apt-get install vagrant virtualbox`

Vagrant tiedoston tekeminen

Uusi hakemisto projektille ja sinne tiedosto nimeltä Vagrantfile, tiedostoon Teron teksti. 

`mkdir twohost/; cd twohost/`
`nano Vagrantfile`

Kirjautuminen ja uloskirjautuminen

`vagrant ssh t001`
`exit`

Hajottaminen
`vagrant destroy`

Uudet koneet samoilla säännöillä: 
`vagrant up`

(Karvinen. 2021)


### Salt Quickstart – Salt Stack Master and Slave on Ubuntu Linux

Ladataan sekä konfiguroidaan master ja minion.

Masterin lataus

- `sudo apt-get -y install salt-master`
- IP-osoitteen selvitys: `hostname -i`

Minionin lataus

- `sudo apt-get update`
- `sudo apt-get -y install salt-minion`

Minionin pitää tietää missä master on ja jokaisella slavella tulee olla uniikki ID.

- `sudoedit /etc/saltminion`
- master: IP-osoite
- id: valitsemasi id

Minion tulee uudelleenkäynnistää, jotta muutokset tulevat voimaan.

- `sudo systemctl restart salt-minion.service`

Ennenkuin master voi kontrolloida minionia, sen tulee hyväksen tunnisteavain.

- `sudo salt-key -A`

Minionin hallinta

- Yhteyden tarkistus: `sudo salt '*' cmd.run whoami`
- Minionin IP-osoitteet: `master$ sudo salt '*' cmd.run 'hostname -I`

(Karvinen. 2018.)

### Hello Salt Infra-as-Code

Salt:n ja micro editorin lataus

`sudo apt-get update`
`sudo apt-get -y install salt-minion micro`
`export EDITOR=micro`

Hakemisto hello moduulille
`sudo mkdir -p /srv/salt/hello`
`cd /srv/salt/hello`

Kirjoitetaan infraa koodina

`sudoedit init.sls`

`tmp/hellotero:
  file.managed`

Ajetaan

`sudo salt-call --local state.apply hello`

Tarkistetaan

`ls /tmp/hellotero`
/tmp/hellotero, jos toimii

(Karvinen. 2014)

### Salt Vagrant - automatically provision one master and two slaves

Infra as Code - Your wishes as a text file

Haluttu koodi kansioon /srv/salt/kansio

`sudo mkdir -p /srv/salt/hello`

Kansioon tiedosto init.sls

`sudoedit /srv/salt/hello/init.sls`

Tiedostoon YAML syntaxilla, sisännys kahdella välilyönnillä

`/tmp/infra-as-code:
  file.managed`

Ajaminen

`sudo salt '*' state.apply hello`

top.sls - What Slave Runs What States

top.sls tiedosto määrittää mitkä minionit ajavat mitkäkin tilat. 

`sudo salt '*' state.apply hello`

`sudoedit /srv/salt/top.sls`

Teksti sinne

`/srv/salt/top.sls
base:
  '*':
    - hello`

(Karvinen. 2023)

### Salt contributor: Salt overview

YAML:n säännöt

YAML on merkintäkieli.
* Data kirjoitetaan avain: arvo -pareissa.
* Avainten arvo voi olla monissa eri rakenteissa. 
* Kaikki on kirjainlyöntikohtaisista. 
* Kommentit alkavat hashilla #.

YAML yksinkertaiset rakenteet

1. Skalaarit:

avain:arvo -kartoitukset missä arvo voi olla numero, merkkijono tai totuusarvomuuttuja.

#avain: arvo
````
vihannekset: herneet

hedelmä: omenat

jyvät: leipä
````

2. Listat

avain: seurattuna lista arvoista, missä jokainen arvo on erillisellä rivillä ja seuraa kaksi välilyöntiä ja kaksoispiste.

#järjestysavain: 
  - arvo1
  - arvo2

```
vihannekset:
  - herneet
  - porkkanat
hedelmät:
  - omenat
  - appelsiinit
````

3. Hakemisto

Kokoelma avain:arvo kartoituksia ja listoja.

```
lounas:

  alkupala: katkarapu cocktail
  juoma: kupliva vesi
  pääruoka:
    - pihvi
    - perunamuussi
    - päivällisrulla
  jälkiruoka:
    - suklaakakku
```

Listat ja hakemistot - YAML:n lohkorakenne

* YAML on organisoitu lohkorakenteisiin.
* Sisennys asettaa kontekstin. Sinun täytyy sisentää omaisuudet yhdellä tai useammalla väliyönnillä, mutta kaksi välilyöntiä on standardi.
* Kokoelma, mikä on lista tai hakemiston lohkorakenne, ilmaisee jokaisen rivin väliviivalla ja välilyönnillä ("- "). 

(Salt overview. 2021-2024.)


### a) Hello Vagrant! Osoita jollain komennolla, että Vagrant on asennettu (esim tulostaa vagrantin versionumeron). Jos et ole vielä asentanut niitä, raportoi myös Vagrant ja VirtualBox asennukset. (Jos Vagrant ja VirtualBox on jo asennettu, niiden asennusta ei tarvitse tehdä eikä raportoida uudelleen.)


![image](https://github.com/user-attachments/assets/40d950f8-6e18-440d-84c6-1c7c7b860eae)

Kuva 1. Vagrant ladattu

Virtualboxin lataaminen ei toiminut `apt-get` komennolla, joten latasin sen Oracle VirtualBoxin nettisivuilta ja sitten komennolla

`sudo apt install ./`



b) Linux Vagrant. Tee Vagrantilla uusi Linux-virtuaalikone.

Minulla oli ongelmia Vagrantin kanssa, johon apuna käytin kanssakurssilaisen tekemää selvitystä. (Bhi083 2024) 

Tein kansion saltdemo ja sinne nanolla tiedostan, jossa Teron koodi. (Karvinen 2021)
`mkdir saltdemo`
`nano Vagrantfile`

Käynnistin vagrantin komennolla

`vagrant up`

Sain virhekoodin:
![image](https://github.com/user-attachments/assets/99c70e27-fc18-47ef-822c-ad169c7b0879)

Kuva 2. Virhekoodin

Kysyin luokkatoverilta apua ja seurasin hänen vianselvitystä. 

"Tämä ei kuitenkaan toiminut, vaan sain virhekoodia siitä, että libvirtd-tiedosto puuttui kokonaan. Joten latasin tarvittavat tiedostot komennolla:

$ sudo apt install qemu-kvm libvirt-clients libvirt-daemon-system virtinst bridge-utils

Ja ajoin uudestaan vagrant up. Tällä kertaa prosessi oikeasti käynnistyi, mutta sain uuden virhekoodin: molemmille virtuaalikoneilla tuli invalid argument: could not get preferred machine for /usr/bin/qemu-system-x86_64 type_kvm.

Yritin korjata tämän ongelman lisäämällä vagrantfileen kohdat:

config.vm.provider :libvirt do |libvirt|

libvirt.driver = qemu"

Sain virhekoodin:
![image](https://github.com/user-attachments/assets/c12119d5-35a2-4740-9872-0286fbd88bfe)

Kuva 3. qemu virhekoodi

En löytänyt tähän apua niin poistin kaverini koodin pätkän ja yritin käynnistää Vagrantin osoittamalla sille et käyttää Virtualboxia komennolla.

`vagrant up --provider=virtualbox`

Sain virhekoodin, että ei löydä Virtualboxia asennusta:

![image](https://github.com/user-attachments/assets/4f3c0004-c0a3-4b06-8af3-e929cf4decbd)

Kuva 4. Virtualbox virhekoodi

Kuitenkin kommennolla virtualbox graafinen käyttöliittymö aukesi ja katsoin, että se oli versiota 7.1.4. 

`virtualbox`

`virtualbox --version`` 

En löytänyt apua tähän, joten jätin läksyn kesken. Palaan tähän, kuin löydän ohjeet, josta selviää mitä pitää tehdä. 



### Lähteet

Karvinen 2021: Two Machine Virtual Network With Debian 11 Bullseye and Vagrant. https://terokarvinen.com/2021/two-machine-virtual-network-with-debian-11-bullseye-and-vagrant/. 


Karvinen 2018: Salt Quickstart – Salt Stack Master and Slave on Ubuntu Linux. https://terokarvinen.com/2018/salt-quickstart-salt-stack-master-and-slave-on-ubuntu-linux/.


Karvinen 2014: Hello Salt Infra-as-Code. https://terokarvinen.com/2024/hello-salt-infra-as-code/


Karvinen 2023: Salt overview. Infra as Code - Your wishes as a text file. top.sls - What Slave Runs What States. https://terokarvinen.com/2023/salt-vagrant/#infra-as-code---your-wishes-as-a-text-file. 


Salt contributors 2021-2024: Salt overview. Rules of YAML. YAML simple structure. Lists and dictionaries - YAML block structures. https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#rules-of-yaml.

Bhi083 2024. H2.md https://github.com/bhi083/Palvelinten_hallinta/blob/main/h2.md












