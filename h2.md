Mikä? Kotitehtävä palvelinten hallinta -kurssille.

Virtuaalikoneen ajo Oracle VM Virtualboxissa Lenovo IdeaPad 1 14" R5-7520U:lla läppärillä.
Kotitehtävä 1: Viisikko

x) Lue ja tiivistä.

### Two Machine Virtual Network With Debian 11 Bullseye and Vagrant.

Vagrantilla voi automaattisesti asentaa Virtualboxiin virtuaalikoneita, joissa on automaattinen Secure Shell kirjautuminen, eikä tarvetta käyttäjän graafiselle käyttöliittymälle ole.

Asennus tapahtuu seuraavasti: 

`sudo apt-get update`
`sudo apt-get install vagrant virtualbox`

Vagrant tiedoston tekeminen

Uusi hakemisto projektille ja sinne tiedosto nimeltä Vagrantfile, tiedostoon seuraava teksti

`mkdir twohost/; cd twohost/`
`nano Vagrantfile`

Kirjautuminen ja uloskirjautuminen

`vagrant ssh t001`
`exit`

Hajottaminen
`vagrant destroy`

Uudet koneet samoilla säännöillä: 
`vagrant up`

(Karvinen. 2021)


### Salt Quickstart – Salt Stack Master and Slave on Ubuntu Linux

Ladataan sekä konfiguroidaan master ja minion.

Masterin lataus

- `sudo apt-get -y install salt-master`
- IP-osoitteen selvitys: `hostname -i`

Minionin lataus

- `sudo apt-get update`
- `sudo apt-get -y install salt-minion`

Minionin pitää tietää missä master on ja jokaisella slavella tulee olla uniikki ID.

- `sudoedit /etc/saltminion`
- master: IP-osoite
- id: valitsemasi id

Minion tulee uudelleenkäynnistää, jotta muutokset tulevat voimaan.

- `sudo systemctl restart salt-minion.service`

Ennenkuin master voi kontrolloida minionia, sen tulee hyväksen tunnisteavain.

- `sudo salt-key -A`

Minionin hallinta

- Yhteyden tarkistus: `sudo salt '*' cmd.run whoami`
- Minionin IP-osoitteet: `master$ sudo salt '*' cmd.run 'hostname -I`

(Karvinen. 2018.)

### Hello Salt Infra-as-Code

Salt and micro editor lataus

`sudo apt-get update`
`sudo apt-get -y install salt-minion micro`
`export EDITOR=micro`

Hakemisto hello moduulille
`sudo mkdir -p /srv/salt/hello`
`cd /srv/salt/hello`

Kirjoitetaan infraa koodina

`sudoedit init.sls`

`tmp/hellotero:
  file.managed`

Ajetaan

`sudo salt-call --local state.apply hello`

Tarkistetaan

`ls /tmp/hellotero`
/tmp/hellotero, jos toimii

(Karvinen. 2014)

### Salt Vagrant - automatically provision one master and two slaves

Infra as Code - Your wishes as a text file

Haluttu koodi kansioon /srv/salt/kansio

`sudo mkdir -p /srv/salt/hello`

kansioon tiedosto init.sls

`sudoedit /srv/salt/hello/init.sls`

tiedostoon YAML syntaxilla, sisännys kahdella välilyönnillä

`/tmp/infra-as-code:
  file.managed`

ajaminen

`sudo salt '*' state.apply hello`

top.sls - What Slave Runs What States

top.sls tiedosto määrittää mitkä minionit ajavat mitkäkin tilat. 

`sudo salt '*' state.apply hello`

`sudoedit /srv/salt/top.sls`

teksti sinne

`/srv/salt/top.sls
base:
  '*':
    - hello`

(Karvinen. 2023)

###Salt contributor: Salt overview

YAML:n säännöt

YAML on merkintäkieli.
* Data kirjoitetaan avain: arvo -pareissa.
* Avainten arvo voi olla monissa eri rakenteissa. 
* Kaikki on kirjainlyöntikohtaisista. 
* Kommentit alkavat hashilla #.

YAML yksinkertaiset rakenteet

1. Skalaarit:

avain:arvo -kartoitukset missä arvo voi olla numero, merkkijono tai totuusarvomuuttuja.

#avain: arvo
````
vihannekset: herneet

hedelmä: omenat

jyvät: leipä
````

2. Listat

avain: seurattuna lista arvoista, missä jokainen arvo on erillisellä rivillä ja seuraa kaksi välilyöntiä ja kaksoispiste.

#järjestysavain: 
  - arvo1
  - arvo2

```
vihannekset:
  - herneet
  - porkkanat
hedelmät:
  - omenat
  - appelsiinit
````

3. Hakemisto

Kokoelma avain:arvo kartoituksia ja listoja.

```
lounas:

  alkupala: katkarapu cocktail
  juoma: kupliva vesi
  pääruoka:
    - pihvi
    - perunamuussi
    - päivällisrulla
  jälkiruoka:
    - suklaakakku
```

Listat ja hakemistot - YAML:n lohkorakenne

* YAML on organisoitu lohkorakenteisiin.
* Sisennys asettaa kontekstin. Sinun täytyy sisentää omaisuudet yhdellä tai useammalla väliyönnillä, mutta kaksi välilyöntiä on standardi.
* Kokoelma, mikä on lista tai hakemiston lohkorakenne, ilmaisee jokaisen rivin väliviivalla ja välilyönnillä ("- "). 

(Salt overview. 2021-2024.)


### a) Hello Vagrant! Osoita jollain komennolla, että Vagrant on asennettu (esim tulostaa vagrantin versionumeron). Jos et ole vielä asentanut niitä, raportoi myös Vagrant ja VirtualBox asennukset. (Jos Vagrant ja VirtualBox on jo asennettu, niiden asennusta ei tarvitse tehdä eikä raportoida uudelleen.)


![image](https://github.com/user-attachments/assets/40d950f8-6e18-440d-84c6-1c7c7b860eae)
Kuva 1. Vagrant ladattu


b) Linux Vagrant. Tee Vagrantilla uusi Linux-virtuaalikone.
c) Kaksin kaunihimpi. Tee kahden Linux-tietokoneen verkko Vagrantilla. Osoita, että koneet voivat pingata toisiaan.
d) Herra-orja verkossa. Demonstroi Salt herra-orja arkkitehtuurin toimintaa kahden Linux-koneen verkossa, jonka teit Vagrantilla. Asenna toiselle koneelle salt-master, toiselle salt-minion. Laita orjan /etc/salt/minion -tiedostoon masterin osoite. Hyväksy avain ja osoita, että herra voi komentaa orjakonetta.
e) Hei infrakoodi! Kokeile paikallisesti (esim 'sudo salt-call --local') infraa koodina. Kirjota sls-tiedosto, joka tekee esimerkkitiedoston /tmp/ -kansioon.
f) Aja esimerkki sls-tiedostosi verkon yli orjalla.
g) Tee sls-tiedosto, joka käyttää vähintään kahta eri tilafunktiota näistä: package, file, service, user. Tarkista eri ohjelmalla, että lopputulos on oikea. Osoita useammalla ajolla, että sls-tiedostosi on idempotentti.
h) Top file. Automatisoi vähintään kahden tilan / modulin ajaminen. Esim. komento 'sudo salt "*" state.apply' tai 'sudo salt-call --local state.apply' ajaa modulit "hello" ja "apache".



### Lähteet

Karvinen 2021: Two Machine Virtual Network With Debian 11 Bullseye and Vagrant. https://terokarvinen.com/2021/two-machine-virtual-network-with-debian-11-bullseye-and-vagrant/. 


Karvinen 2018: Salt Quickstart – Salt Stack Master and Slave on Ubuntu Linux. https://terokarvinen.com/2018/salt-quickstart-salt-stack-master-and-slave-on-ubuntu-linux/.


Karvinen 2014: Hello Salt Infra-as-Code. https://terokarvinen.com/2024/hello-salt-infra-as-code/


Karvinen 2023: Salt overview. Infra as Code - Your wishes as a text file. top.sls - What Slave Runs What States. https://terokarvinen.com/2023/salt-vagrant/#infra-as-code---your-wishes-as-a-text-file. 


Salt contributors 2021-2024: Salt overview. Rules of YAML. YAML simple structure. Lists and dictionaries - YAML block structures. https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#rules-of-yaml.









