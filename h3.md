## Mikä? Kotitehtävä palvelinten hallinta -kurssille.

Vagrantin ajo Windowsilla Lenovo IdeaPad 1 14" R5-7520U:lla läppärillä.

### Kotitehtävä 3: Demoni

**x) Lue ja tiivistä.**

### Karvinen 2018: Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port

Konfiguraation hallintajärjestelmällä voi kontrolloida monia demoneita. Paketti-tiedosto-järjestelmällä on tähän järjestys:
  1. Asenna dovellus
  2. Korvaa konfiguraatiotiedosto
  3. Uudelleenkäynnistä demoni käyttämään uutta konfiguraatiota

Kun sinulla on salt master-minion arkkitehtuuri, tee masterilla tila (sshd.sls) ja konfiguraatiotiedoston pääkopio (sshd_config).


Esimerkkinä SSH-palvelin, jossa käytössä openssh-server-paketti. Tässä sen tila-tiedosto sshd.sls /srv/salt -hakemistossa. 

```
openssh-server:
 pkg.installed
/etc/ssh/sshd_config:
 file.managed:
   - source: salt://sshd_config
sshd:
 service.running:
   - watch:
     - file: /etc/ssh/sshd_config
```

- pkg.installed asentaa openssh-server demonin jos sitä ei jo ole.

- file.managed määrittää että tiedostoa /etc/ssh/sshd_config hallitaan Saltin avulla.

- service.running käynnistää sshd demonin & watch:lla tehdään automaattisest uudelleenkäynnistyksen, jos konfiguraatiotiedoston pääkopioon tulee muutoksia. 

Sen jälkeen konfiguraatiotiedoston pääkopio sshd_config samassa hakemistossa.

```
# DON'T EDIT - managed file, changes will be overwritten
Port 8888
Protocol 2
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_dsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key
UsePrivilegeSeparation yes
KeyRegenerationInterval 3600
ServerKeyBits 1024
SyslogFacility AUTH
LogLevel INFO
LoginGraceTime 120
PermitRootLogin prohibit-password
StrictModes yes
RSAAuthentication yes
PubkeyAuthentication yes
IgnoreRhosts yes
RhostsRSAAuthentication no
HostbasedAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no
X11Forwarding yes
X11DisplayOffset 10
PrintMotd no
PrintLastLog yes
TCPKeepAlive yes
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/openssh/sftp-server
UsePAM yes
```

Tämän jälkeen voit laittaa tilan minioneille sekä tarkistaa toimiiko komennoilla:

```
sudo salt '*' state.apply sshd
nc -vz minion portti
````

(Karvinen 2018)



### a) Apache easy mode. Asenna Apache, korvaa sen testisivu ja varmista, että demoni käynnistyy.

Kirjauduin aikasemmin kurssilla tekemääni t001 masteriin ja päivitin paketin. Olin ladannut apachen viime kotiläksyssä niin poistin sen oletus index.html -tiedoston /var/www/html -hakemistosta ja tein tilalle uuden. Katsoin vielä masterin ip:n ja heitin sen selaimeen, jolloin sivuni näkyi.

```
vagrant ssh t001
sudo apt-get update
sudo apt install apache2 -y
sudo rm /var/www/html/index.html
sudoedit /var/ww/html/index.html
ip -a
```

![image](https://github.com/user-attachments/assets/37b83568-2037-4e23-b31c-5677fa853aa8)

Kuva 1. Apache käsintehtynä. 


Koska minulla oli jo valmiina /srv/salt/apache kansio, jossa koodi apachen asennukseen ja lataukseen, lisäsin sinne tiedon, että /var/www/html/index.html, päivittyy /srv/salt/apache/index.html mukaan. 

![image](https://github.com/user-attachments/assets/3c5fca29-167c-453f-ba88-a1322477b727)

Kuva 2. Päivitys

Sitten ajoin tilan lokaalisti ja se toimi, jonka sen jälkeen verkon yli minionilla.

```
sudo salt-call --local state.apply apache

sudo salt '*' state.apply apache
```


![image](https://github.com/user-attachments/assets/d4b132d5-e88b-4af3-82e9-4afae5b6f0c0)

Kuva 3. Lokaalisti



![image](https://github.com/user-attachments/assets/75f570a6-e06f-4f92-937c-4d6010b5c05a)

Kuva 4. Minionin ajo


![image](https://github.com/user-attachments/assets/ae929c5f-a847-40b4-b60e-8c04c167704a)

Kuva 5. Minionin apache -sivu 

### b) SSHouto. Lisää uusi portti, jossa SSHd kuuntelee. Jos käytät Vagrantia, muista jättää portti 22/tcp auki - se on oma yhteytesi koneeseen. SSHd:n asetustiedostoon voi tehdä yksinkertaisesti kaksi "Port" riviä, molemmat portit avataan.  Löydät oikean asetuksen katsomalla SSH:n asetustiedostoa. Nyt tarvitaan service-watch, jotta demoni käynnistetään uudelleen, jos asetustiedosto muuttuu masterilla.

![image](https://github.com/user-attachments/assets/a6b74c45-9142-474b-8121-16b66111001e)

sshd.sls


sshd_config

![image](https://github.com/user-attachments/assets/2cb3a35f-9c92-4afa-85ac-32993b11582c)




![image](https://github.com/user-attachments/assets/f6b03dc2-b7b5-4281-b708-591b805d75d5)


Yritin vielä komennoilla testata, että onhan portti auki, mutta en saanut oikeaa vastausta. 

![image](https://github.com/user-attachments/assets/c14b28fe-bc7f-44d2-939c-abe675538f6d)





### c) Oma moduli

Omaksi moduuliksi ajattelin tehdä työpöydän. Verkkosivulle apachella valokuvagallerian, jonne voin laittaa ottamiani valokuvia. Lisäksi discordin, jossa voin jakaa valokuvia kavereilleni sekä Gimpin, jolla voin muokata valokuvia.   


### d) Virtualhost. Asenna Apache tarjoilemaan weppisivua. Weppisivun tulee näkyä palvelimen etusivulla (localhost). HTML:n tulee olla jonkun käyttäjän kotihakemistossa, ja olla muokattavissa normaalin käyttäjän oikeuksin, ilman sudoa.

kuva 

![image](https://github.com/user-attachments/assets/60571005-4087-450e-a08f-643746662635)

kuva. init.sls 


![image](https://github.com/user-attachments/assets/90ffed66-e72d-487b-a912-d88031733956)

kuva. ajo

![image](https://github.com/user-attachments/assets/1a5ece00-13a3-4cfe-9299-dc0d84ba719d)

oikee ajo


muokattu init.sls

![image](https://github.com/user-attachments/assets/af352adc-ed85-4170-ba93-02f0e1480abc)




![image](https://github.com/user-attachments/assets/85eccf26-83ad-41b8-b4a8-0a2218c50238)

![image](https://github.com/user-attachments/assets/249e3f66-7c3b-45c6-8ae6-9e501234aa0d)

muokattu sivu



### Lähteet

Karvinen 2018: Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port. Luettavissa: https://terokarvinen.com/2018/04/03/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/?fromSearch=karvinen%20salt%20ssh


