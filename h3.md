## Mikä? Kotitehtävä palvelinten hallinta -kurssille.

Vagrantin ajo Windowsilla Lenovo IdeaPad 1 14" R5-7520U:lla läppärillä.

### Kotitehtävä 3: Demoni

**x) Lue ja tiivistä.**

### Karvinen 2018: Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port

Konfiguraation hallintajärjestelmällä voi kontrolloida monia demoneita. Paketti-tiedosto-järjestelmällä on tähän järjestys:
  1. Asenna dovellus
  2. Korvaa konfiguraatiotiedosto
  3. Uudelleenkäynnistä demoni käyttämään uutta konfiguraatiota

Kun sinulla on salt master-minion arkkitehtuuri, tee masterilla tila (sshd.sls) ja konfiguraatiotiedoston pääkopio (sshd_config).


Esimerkkinä SSH-palvelin, jossa käytössä openssh-server-paketti. Tässä sen tila-tiedosto sshd.sls /srv/salt -hakemistossa. 

```
openssh-server:
 pkg.installed
/etc/ssh/sshd_config:
 file.managed:
   - source: salt://sshd_config
sshd:
 service.running:
   - watch:
     - file: /etc/ssh/sshd_config
```

pkg.installed asentaa openssh-server demonin jos sitä ei jo ole.

file.managed määrittää että tiedostoa /etc/ssh/sshd_config hallitaan Saltin avulla.

service.running käynnistää sshd demonin & watch:lla tehdään automaattisest uudelleenkäynnistyksen jos konfiguraatiotiedoston pääkopioon tulee muutoksia. 

Sen jälkeen konfiguraatiotiedoston pääkopio sshd_config samassa hakemistossa.

```
# DON'T EDIT - managed file, changes will be overwritten
Port 8888
Protocol 2
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_dsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key
UsePrivilegeSeparation yes
KeyRegenerationInterval 3600
ServerKeyBits 1024
SyslogFacility AUTH
LogLevel INFO
LoginGraceTime 120
PermitRootLogin prohibit-password
StrictModes yes
RSAAuthentication yes
PubkeyAuthentication yes
IgnoreRhosts yes
RhostsRSAAuthentication no
HostbasedAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no
X11Forwarding yes
X11DisplayOffset 10
PrintMotd no
PrintLastLog yes
TCPKeepAlive yes
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/openssh/sftp-server
UsePAM yes
```

Tämän jälkeen voit laittaa tilan minioneille sekä tarkistaa toimiiko komennoilla:

```
sudo salt '*' state.apply sshd
nc -vz minion portti
````

(Karvinen 2018)



### a) Apache easy mode. Asenna Apache, korvaa sen testisivu ja varmista, että demoni käynnistyy.

Kirjauduin aikasemmin kurssilla tekemääni t001 masteriin ja päivitin paketin. Olin ladannut apachen viime kotiläksyssä niin poistin sen oletus index.html -tiedoston /var/www/html -hakemistosta ja tein tilalle uuden. Katsoin vielä masterin ip:n ja heitin sen selaimeen, jolloin sivuni näkyi.

```
vagrant ssh t001
sudo apt-get update
sudo apt install apache2 -y
sudo rm /var/www/html/index.html
sudoedit /var/ww/html/index.html
ip -a
```

![image](https://github.com/user-attachments/assets/37b83568-2037-4e23-b31c-5677fa853aa8)

Kuva 1. Apache käsintehtynä. 

Tein /srv/salt/apache kansioon index.html tiedoston, jonne laitoin äskön tekemäni html koodin.

Koska minulla oli jo valmiina /srv/salt/apache kansio, jossa koodi apachen asennukseen ja lataukseen, lisäsin sinne tiedon, että /var/www/html/index.html, päivittyy apache/index.html mukaan. 

![image](https://github.com/user-attachments/assets/3c5fca29-167c-453f-ba88-a1322477b727)


![image](https://github.com/user-attachments/assets/f1682e01-3217-4fb9-86d7-80fc5e119713)


Kuva 2. Päivitys

Sitten ajoin tilan lokaalisti.










### b) SSHouto. Lisää uusi portti, jossa SSHd kuuntelee. 


### c) Oma moduli

Omaksi moduuliksi ajattelin tehdä verkkosivulle valokuvagallerian, jonne voin laittaa ottamiani valokuvia. Laitan Vagrantilla virtuaalikoneen sekä Saltilla automatisoin asennuksen. 


### d) Virtualhost. Asenna Apache tarjoilemaan weppisivua. Weppisivun tulee näkyä palvelimen etusivulla (localhost). HTML:n tulee olla jonkun käyttäjän kotihakemistossa, ja olla muokattavissa normaalin käyttäjän oikeuksin, ilman sudoa.


### Lähteet

Karvinen 2018: Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port. Luettavissa: https://terokarvinen.com/2018/04/03/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/?fromSearch=karvinen%20salt%20ssh


